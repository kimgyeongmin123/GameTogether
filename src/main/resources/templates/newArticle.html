<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>newArticle</title>

    <!--    Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        .game-radio {
            display: none;
        }

        .game-label {
            display: inline-block;
            width: 100px;
            height: 100px;
            background-size: cover;
            cursor: pointer;
        }

        .game-label.selected {
            border: 2px solid red;
        }
    </style>
</head>
<body>

<header>
    <h1>Mango (✌’ω’)✌</h1>
    <h5>망고의 게시판에 오신 것을 환영합니다.</h5>
</header>

<main>
    <section>
        <div class="form-check form-check-inline">
            <label class="game-label" for="gameRadio1" style="background-image:url('/img/lolLogo.png')"></label>
            <input class="game-radio" type="radio" name="inlineRadioOptions" id="gameRadio1" value="리그오브레전드">

        </div>
        <div class="form-check form-check-inline">
            <label class="game-label" for="gameRadio2" style="background-image:url('/img/overLogo.png')"></label>
            <input class="game-radio" type="radio" name="inlineRadioOptions" id="gameRadio2" value="오버워치">

        </div>
    </section>
    <div class="card">
        <input type="hidden" id="article-id" th:value="${article.id}">
        <input type="text" class="card-header" placeholder="제목" id="title" th:value="${article.title}">

        <div class="card-body">
            <textarea class="card-title" placeholder="내용" id="content" th:text="${article.content}"></textarea>

            <button th:if="${article.id}!=null" type="button" id="modify-btn" class="btn btn-primary">수정</button>
            <button th:if="${article.id}==null" type="button" id="create-btn" class="btn btn-primary">등록</button>

        </div>
    </div>
</main>

<script>
    var selectedGame;

    document.querySelectorAll('.game-label').forEach(function(label) {
        label.addEventListener('click', function() {
            label.classList.toggle('selected');
            selectedGame = label.nextElementSibling.value;
            console.log(selectedGame);
            document.querySelectorAll('.game-label').forEach(function(otherLabel) {
                if (otherLabel !== label) {
                    otherLabel.classList.remove('selected');
                }
            });
        });
    });
</script>

<script>
// 생성 기능
const createButton = document.getElementById('create-btn');

if (createButton) {
    // 등록 버튼을 클릭하면 /api/articles로 요청을 보낸다
    createButton.addEventListener('click', event => {
        body = JSON.stringify({
            selectedGame: selectedGame,
            title: document.getElementById('title').value,
            content: document.getElementById('content').value
        });
        function success() {
            alert('등록 완료되었습니다.');
            location.replace('/articles');
        };
        function fail() {
            alert('등록 실패했습니다.');
            location.replace('/articles');
        };

        httpRequest('POST','/api/articles', body, success, fail)
    });
}

// 수정 기능
const modifyButton = document.getElementById('modify-btn');

if (modifyButton) {
    modifyButton.addEventListener('click', event => {
        let params = new URLSearchParams(location.search);
        let id = params.get('id');

        body = JSON.stringify({
            title: document.getElementById('title').value,
            content: document.getElementById('content').value
        })

        function success() {
            alert('수정 완료되었습니다.');
            location.replace(`/articles/${id}`);
        }

        function fail() {
            alert('수정 실패했습니다.');
            location.replace(`/articles/${id}`);
        }

        httpRequest('PUT',`/api/articles/${id}`, body, success, fail);
    });
}

// 쿠키를 가져오는 함수
function getCookie(key) {
    var result = null;
    var cookie = document.cookie.split(';');
    cookie.some(function (item) {
        item = item.replace(' ', '');

        var dic = item.split('=');

        if (key === dic[0]) {
            result = dic[1];
            return true;
        }
    });

    return result;
}

// HTTP 요청을 보내는 함수
function httpRequest(method, url, body, success, fail) {
    fetch(url, {
        method: method,
        headers: { // 로컬 스토리지에서 액세스 토큰 값을 가져와 헤더에 추가
            Authorization: 'Bearer ' + localStorage.getItem('access_token'),
            'Content-Type': 'application/json',
        },
        body: body,
    }).then(response => {
    console.log(localStorage.getItem('access_token'));
    console.log('response.status:', response.status);
        if (response.status === 200 || response.status === 201) {
            return success();
        }
        const refresh_token = getCookie('refresh_token');
        if (response.status === 401 && refresh_token) {
            fetch('/api/token', {
                method: 'POST',
                headers: {
                    Authorization: 'Bearer ' + localStorage.getItem('access_token'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    refreshToken: getCookie('refresh_token'),
                }),
            })
                .then(res => {
                    if (res.ok) {
                        return res.json();
                    }
                })
                .then(result => { // 재발급이 성공하면 로컬 스토리지값을 새로운 액세스 토큰으로 교체
                    localStorage.setItem('access_token', result.accessToken);
                    httpRequest(method, url, body, success, fail);
                })
                .catch(error => fail());
        } else {
            return fail();
        }
    });
}
</script>

</body>
</html>